pipeline {
    agent any

    environment {
        // Jenkins credentials
        GCP_PROJECT_ID = credentials('gcp-project-id')
        GCP_SA_KEY     = credentials('gcp-service-account-json')

        // GCP deployment config
        REGION         = 'us-central1'
        REPO           = 'research-assistant-repo'
        IMAGE_NAME     = 'research-assistant-agent'

        // App-specific env (if you want to inject at deploy time)
        FLASK_PORT     = '8080'
        GRADIO_PORT    = '7860'
        API_BASE       = 'http://localhost:8080'
    }

    options {
        timestamps()
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Setup gcloud') {
            steps {
                sh '''
                  echo "$GCP_SA_KEY" > /tmp/gcloud-key.json

                  gcloud auth activate-service-account --key-file=/tmp/gcloud-key.json
                  gcloud config set project $GCP_PROJECT_ID
                  gcloud config set compute/region $REGION

                  gcloud auth configure-docker $REGION-docker.pkg.dev --quiet
                '''
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    // Use short git commit hash as tag
                    def GIT_SHORT = sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
                    env.IMAGE_URI = "${REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${REPO}/${IMAGE_NAME}:${GIT_SHORT}"
                }
                sh '''
                  echo "Building image: $IMAGE_URI"
                  docker build -t "$IMAGE_URI" .
                '''
            }
        }

        stage('Push Image to Artifact Registry') {
            steps {
                sh '''
                  echo "Pushing image: $IMAGE_URI"
                  docker push "$IMAGE_URI"
                '''
            }
        }

        stage('Deploy to Cloud Run') {
            steps {
                sh '''
                  echo "Deploying to Cloud Run: $IMAGE_URI"

                  gcloud run deploy research-assistant-service \
                    --image "$IMAGE_URI" \
                    --platform managed \
                    --region "$REGION" \
                    --allow-unauthenticated \
                    --port 7860 \
                    --set-env-vars FLASK_PORT=$FLASK_PORT,GRADIO_PORT=$GRADIO_PORT,API_BASE=$API_BASE
                '''
            }
        }
    }

    post {
        always {
            sh 'rm -f /tmp/gcloud-key.json || true'
        }
        success {
            echo "Deployment completed successfully."
        }
        failure {
            echo "Deployment failed."
        }
    }
}
